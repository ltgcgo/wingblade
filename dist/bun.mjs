// Copyright (c) Lightingale WingBlade Author(s) 2023.
// Licensed under GNU LGPL 3.0 or later.
"use strict";import os from"node:os";import dns from"node:dns";let U=Object.defineProperty;let A=(e,t,r)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;let i=(e,t,r)=>(A(e,typeof t!="symbol"?t+"":t,r),r);let S={args:Bun.argv.slice(2),main:Bun.main};let g=class{constructor(e,t="granted"){if(!e)throw new TypeError(`The provided value "${e}" is not a valid permission name.`);this.name=e,this.state=t}};let v={version:"0.1"};let I={query:async e=>new g(e?.name),request:async e=>new g(e?.name),revoke:async e=>new g(e?.name),querySync:e=>new g(e?.name),requestSync:e=>new g(e?.name),revokeSync:e=>new g(e?.name)},h,L=(h=class{static get memory(){let{rss:e,heapTotal:t,heapUsed:r,external:s}=process.memoryUsage(),n=os.totalmem(),o=os.freemem();return{rss:e,heapTotal:t,heapUsed:r,external:s,total:n,free:o}}static exit(e=0){process.exit(e)}static gid(){return os.userInfo().gid}static interfaces(){let e=os.networkInterfaces(),t=[];for(let r in e)for(let s=0;s<e[r].length;s++){let{address:n,cidr:o,netmask:a,family:l,mac:c,internal:u,scope_id:f}=e[r][s];c||(c="00:00:00:00:00:00"),t.push({family:l,name:r,address:n,netmask:a,scopeid:f,cidr:o,mac:c})}return t}static systemMemoryInfo(){return{total:os.totalmem(),free:os.freemem()}}static uid(){return os.userInfo().uid}},i(h,"os",process.platform),i(h,"variant","Bun"),i(h,"version",Bun.version),i(h,"versions",{deno:"1.36.4",v8:process.versions.v8.split("-")[0],wingblade:v.version}),i(h,"persist",!0),i(h,"networkDefer",!1),i(h,"cores",os.cpus().length),i(h,"perms",I),i(h,"noColor",process.env.NO_COLOR?.length>0),i(h,"pid",process.pid),i(h,"ppid",process.ppid),i(h,"chdir",process.chdir),i(h,"cwd",process.cwd),i(h,"execPath",process.execPath),i(h,"hostname",os.hostname),i(h,"ifMap",os.networkInterfaces),i(h,"loadavg",os.loadavg),i(h,"memoryUsage",process.memoryUsage),i(h,"osUptime",os.uptime),h),y="delete,get,has,set,toObject".split(","),x=new Proxy({get:(e,t)=>Bun.env[e]||t,set:(e,t)=>{Bun.env[e]=t},delete:e=>{delete Bun.env[e]},has:e=>!!Bun.env[e],toObject:()=>Bun.env},{get:(e,t)=>y.indexOf(t)<0&&t.constructor==String?e.get(t):e[t],set:(e,t,r)=>{if(y.indexOf(t)<0)if(t.constructor==String)e.set(t,r);else throw new TypeError("Invalid type for key");else throw new Error("Tried to write protected properties")},has:(e,t)=>y.indexOf(t)<0?t.constructor==String?e.has(t):e[t]!=null:!1,deleteProperty:(e,t)=>{if(y.indexOf(t)<0)if(t.constructor==String)e.delete(t);else throw new TypeError("Invalid type for key");else throw new Error("Tried to delete protected properties")}});let j=class{static async read(e,t){return new Uint8Array(await Bun.file(e).arrayBuffer())}static async write(e,t,r){await Bun.write(e,t)}},C=j;let q=class extends EventTarget{#e;#r;#t;#a;#c;#u;#l;#s;#o=[];#i=[];#n=3;#h=!1;CONNECTING=0;OPEN=1;CLOSING=2;CLOSED=3;get protocol(){return this.#e}get hostname(){return this.#r}get port(){return this.#t}get readyState(){return this.#n}get source(){return this.#l}get sink(){return this.#s}addEventListener(e,t,r){e=="open"&&this.readyState==this.OPEN&&t.call(this,new Event("open")),super.addEventListener(e,t,r)}send(e){if(this.#h)throw new Error("Cannot enqueue or send data on a freed connection");this.#n!=1?this.#o.push(e):this.#s?.desiredSize<0||this.#i.length?(this.#i.push(e),this.#s.ready.then(()=>{let t=this.#i.shift();t&&this.#s.write(t)})):this.#s.write(e)}async connect(){if(this.#h)throw new Error("Cannot restart a freed connection");switch(this.#n<this.CLOSING&&console.debug(`${this.#e.toUpperCase()} connection is already open.`),this.#n=this.CONNECTING,this.#e){case"tcp":break;default:throw this.free(),new Error(`Invalid protocol "${this.#e}"`)}this.#n=this.OPEN,this.dispatchEvent(new Event("open"))}close(){switch(this.#n>this.OPEN&&console.debug(`${this.#e.toUpperCase()} connection is already closed.`),this.#n=this.CLOSING,this.#e){case"tcp":break;default:throw this.free(),new Error(`Invalid protocol "${this.#e}"`)}this.#n=this.CLOSED,this.dispatchEvent(new Event("close"))}free(){return this.close(),this.#h=!0,this.#o.splice(0,this.#o.length)}constructor({proto:e,host:t,port:r},s){super(),e=e||"tcp",t=t||"127.0.0.1",r=r||80,this.#e=e,this.#r=t,this.#t=r,this.addEventListener("open",async()=>{this.#o.forEach(n=>{this.send(n)})}),this.addEventListener("close",()=>{this.#i.length&&this.#o.splice(0,0,this.#i.splice(0,this.#i.length))}),s&&this.connect()}},T,D=(T=class{},i(T,"RawClient",q),T),M=D;let B='<!DOCTYPE html><head><meta charset="utf-8"/><title>WingBlade error</title><style>body{background:#000;color:#ccc;}</style></head><body><div style="width:75vw;min-width:360px;max-width:1080px;margin:0 auto;"><p>WingBlade has encountered an error on ${runtime}.</p><pre>${stackTrace}</pre></div></body>\n';let G=class extends EventTarget{#e;#r;#t=!1;#a=[];#c={open:[],message:[],error:[],close:[]};addEventListener(e,t,r){e=="open"&&this.readyState<2&&t.call(this,new Event("open")),super.addEventListener(e,t,r)}get binaryType(){return this.#e?.binaryType||""}get bufferedAmount(){return this.#e?.bufferedAmount||0}get extensions(){return this.#e?.extensions||""}get readyState(){return this.#e?.readyState||0}get url(){return this.#e?.url||this.#r}attach(e){if(this.#t)return!1;if(this.#e)throw new Error("Already attached a WebSocket object");this.#e=e;let t=this;switch(e.readyState){case 0:case 1:{t.dispatchEvent(new Event("open"));break}case 2:case 3:{t.dispatchEvent(new Event("close"));break}}}close(...e){return this.#t=!0,this.#e?.close(...e)}send(e){return this.#e?this.#e.send(e):(this.#a.push(e),e.length||e.size||e.byteLength||0)}constructor(e){super(),this.#r=e.url.replace("http","ws"),this.addEventListener("open",t=>{for(;this.#a.length>0;)this.#e.send(this.#a.shift())})}},V=class{static serve(e,t={}){let r=`${process.cwd()}`,s=t.port||8e3,n=t.hostname||"0.0.0.0",o=Bun.serve({port:s,hostname:n,fetch:async(a,l)=>{a.socket=l;try{let c=await e(a);return c?.constructor!=Response&&(c=new Response(JSON.stringify(c),{headers:{"Content-Type":"text/plain"}})),c}catch(c){let u=c.stack.split(`
`);return u.forEach((f,m,E)=>{E[m]=f.replace("@"," at ").replace("[native code]","bun:internal")}),u.unshift(`${c.name||"Error"}${c.message?":":""} ${c.message||""}`),u=u.join(`
    `),console.error(`Request error at ${a.method} ${a.url}
${u}`),new Response(B.replace("${runtime}",WingBlade.rt.variant).replace("${stackTrace}",u.replaceAll(r,"wingblade:app")),{status:502,headers:{"Content-Type":"text/html"}})}},websocket:{open(a){let l=a.data.wsServer;l.attach(a),l.dispatchEvent(new Event("open"))},message(a,l){a.data.wsServer.dispatchEvent(new MessageEvent("message",{data:l}))},close(a,l,c){a.data.wsServer.dispatchEvent(new Event("close"))}}});return console.error(`WingBlade serving at http://${n=="0.0.0.0"?"127.0.0.1":n}:${s}`),o}static acceptWs(e,t){let r=new G(e);return e.socket.upgrade(e,{data:{wsServer:r}}),{socket:r,response:new Response(null,{status:200})}}},O=V;let _=class{static randomInt(e){return Math.floor(Math.random()*e)}static async sleep(e,t=0){await Bun.sleep(e+Math.floor(t*Math.random()))}},$=_;if(self.ReadableStream)ReadableStream.prototype.array=function(){return Bun.readableStreamToArray(this)},ReadableStream.prototype.arrayBuffer=function(){return Bun.readableStreamToArrayBuffer(this)},ReadableStream.prototype.blob=function(){return Bun.readableStreamToBlob(this)},ReadableStream.prototype.json=function(){return Bun.readableStreamToJSON(this)},ReadableStream.prototype.text=function(){return Bun.readableStreamToText(this)};else throw"ReadableStream not present in this runtime.";let z=class{#e=!1;#r;#t;resolve(t){let r=this;r.resolved||(r.#e=!0,r.#r=t,r.#t&&(r.#t(t),r.#t=void 0))}wait(){let t=this;return t.#e?new Promise(r=>{r(t.#r)}):new Promise(r=>{t.#t=r})}},H=class{#e=256;#r=0;#t;#a;#c;#u;#l;#s=new z;alwaysCopy=!1;get chunk(){return this.#e}get sink(){return this.#t}get source(){return this.#c}attach(t){let r=this;r.#t=t,r.#a=t.getReader(),r.#s.resolve()}constructor(t=1024,r=!1){let s=this;s.#e=t,s.alwaysCopy=r,s.#l=new ByteLengthQueuingStrategy({highWaterMark:t});let n=0,o;s.#c=new ReadableStream({cancel:async a=>{await s.#t.cancel(a)},start:async a=>{},pull:async a=>{s.#r++;let l=!1;await s.#s.wait();let c=!0,u=0;for(;c&&u<s.#e;){let{done:f,value:m}=await s.#a.read(),E=m?.byteLength||0;u+=E;let N=0,p,k=!0;if(m?.byteLength)for(p=new Uint8Array(m.buffer,m.byteOffset,m.byteLength);k;){let w;if(p.byteLength<1&&(k=!1),n){let b=p.subarray(0,s.#e-n);o.set(b,n),n+b.byteLength<s.#e?n+=p.byteLength:(w=o,n=0,o=new Uint8Array(s.#e)),p=p.subarray(b.byteLength)}else p.byteLength<s.#e?(n=p.byteLength,o?.constructor!=Uint8Array&&(o=new Uint8Array(s.#e)),o.set(p)):s.alwaysCopy?(w=new Uint8Array(s.#e),w.set(p.subarray(0,s.#e))):w=p.subarray(0,s.#e),p=p.subarray(s.#e);w&&(a.enqueue(new Uint8Array(w)),N+=w?.byteLength)}f&&(n&&a.enqueue(o.subarray(0,n)),a.close(),c=!1)}}},this.#l)}},R=H;let P=function(e){self.navigator||(self.navigator={});let t=navigator;switch(t.userAgent||(t.userAgent=`${e.rt.variant}/${e.rt.version}`),t.language||(t.language=null),t.languages?.constructor||(t.languages=[]),t.hardwareConcurrency||(t.hardwareConcurrency=e.rt.cores),t.deviceMemory||(t.deviceMemory=Math.min(2**Math.round(Math.log2(e.rt.memory.total/1073741824)),8)),t.permissions||(t.permissions={query:r=>e.rt.perms.querySync(r)}),e.rt.variant){case"Node":case"Bun":break;case"Deno":break}switch(e.rt.variant){case"Deno":{let r=Worker;self.Worker=class extends EventTarget{#e;postMessage(s,n){this.#e.postMessage(s,n)}terminate(){this.#e.terminate()}constructor(s,n={}){super();let o=this;s=new URL(s,`file://${e.rt.cwd()}/`).href,(!n.type||n.type=="classic")&&(n.type="module"),o.#e=new r(s,n),o.#e.addEventListener("message",({data:a,origin:l,source:c,ports:u})=>{o.dispatchEvent(new MessageEvent("message",{data:a,origin:l,source:c,ports:u}))}),o.#e.addEventListener("error",({message:a,filename:l,lineno:c,colno:u,error:f})=>{o.dispatchEvent(new ErrorEvent("error",{message:a,filename:l,lineno:c,colno:u,error:f||new Error(a,l,c)}))}),o.#e.addEventListener("messageerror",({data:a})=>{o.dispatchEvent(new MessageEvent("messageerror",{data:a,origin,source,ports}))})}};break}case"Node":{self.Worker=class extends EventTarget{#e;#r={};addEventListener(r,s,n){let o=this,a=function(l){if(l.data?.wbType=="!ErrorEvent"){for(let c in l.data)c!="wbType"&&(l[c]=l.data[c]);delete l.data}s.call(o,l)};o.#r[s]=a,super.addEventListener(r,a,n)}postMessage(r,s){this.#e.postMessage(r,s)}terminate(){this.#e.terminate()}constructor(r,s={}){super();let n=this;r=new URL(new URL(r,`file://${e.rt.cwd()}/`).href),s.env=s.env||workerThreads.SHARE_ENV,n.#e=new workerThreads.Worker(r,s),n.#e.on("message",o=>{n.dispatchEvent(new MessageEvent("message",{data:o,origin:r}))}),n.#e.on("error",o=>{let{message:a,filename:l,lineno:c,colno:u}=o;n.dispatchEvent(new MessageEvent("error",{data:{error:o,message:a,filename:l,lineno:c,colno:u,wbType:"!ErrorEvent"}}))}),n.#e.on("messageerror",o=>{n.dispatchEvent(new MessageEvent("messageerror",{data:o,origin:r}))})}},workerThreads.isMainThread||(self.postMessage=function(r,s){workerThreads.parentPort.postMessage(r,s)},self.addEventListener=function(r,s){switch(r){case"message":{workerThreads.parentPort.on("message",n=>{s.call(self,new MessageEvent("message",{data:n}))});break}}});break}}};self.ChokerStream=R;let d,J=(d=class{},i(d,"args",S.args),i(d,"main",S.main),i(d,"version",v.version),i(d,"rt",L),i(d,"env",x),i(d,"file",C),i(d,"net",M),i(d,"web",O),i(d,"util",$),d);P(J);export{J as WingBlade};
