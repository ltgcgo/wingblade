var O=Object.defineProperty;var T=(t,e,r)=>e in t?O(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var o=(t,e,r)=>(T(t,typeof e!="symbol"?e+"":e,r),r);var l,v=(l=class{static get memUsed(){return Deno.memoryUsage()}static exit(t=0){Deno.exit(t)}},o(l,"os",Deno.build.os),o(l,"variant","Deno"),o(l,"version",Deno.version.deno),o(l,"persist",!0),o(l,"networkDefer",!1),l),d="delete,get,has,set,toObject".split(","),g=new Proxy({get:(t,e)=>Deno.env.get(t)||e,set:(t,e)=>{Deno.env.set(t,e)},delete:t=>{Deno.env.delete(t)},has:t=>Deno.env.has(t),toObject:()=>Deno.env.toObject()},{get:(t,e)=>d.indexOf(e)<0&&e.constructor==String?t.get(e):t[e],set:(t,e,r)=>{if(d.indexOf(e)<0)if(e.constructor==String)t.set(e,r);else throw new TypeError("Invalid type for key");else throw new Error("Tried to write protected properties")},has:(t,e)=>d.indexOf(e)<0?e.constructor==String?t.has(e):t[e]!=null:!1,deleteProperty:(t,e)=>{if(d.indexOf(e)<0)if(e.constructor==String)t.delete(e);else throw new TypeError("Invalid type for key");else throw new Error("Tried to delete protected properties")}});var A=class{static async read(t,e){return await Deno.readFile(t,e)}static async write(t,e,r){await Deno.writeFile(t,e,r)}},E=A;var R=class extends EventTarget{#e;#r;#s;#t;#n;#d;#a;#o;#l=[];#c=[];#i=3;#h=!1;CONNECTING=0;OPEN=1;CLOSING=2;CLOSED=3;get protocol(){return this.#e}get hostname(){return this.#r}get port(){return this.#s}get readyState(){return this.#i}get source(){return this.#a}get sink(){return this.#o}addEventListener(t,e,r){t=="open"&&this.readyState==this.OPEN&&e.call(this,new Event("open")),super.addEventListener(t,e,r)}send(t){if(this.#h)throw new Error("Cannot enqueue or send data on a freed connection");this.#i!=1?this.#l.push(t):this.#o?.desiredSize<0||this.#c.length?(this.#c.push(t),this.#o.ready.then(()=>{let e=this.#c.shift();e&&this.#o.write(e)})):this.#o.write(t)}async connect(){if(this.#h)throw new Error("Cannot restart a freed connection");switch(this.#i<this.CLOSING&&console.debug(`${this.#e.toUpperCase()} connection is already open.`),this.#i=this.CONNECTING,this.#e){case"tcp":{let t=await Deno.connect({hostname:this.#r,port:this.#s});this.#t=t,this.#n=t.readable,this.#a=t.readable.getReader(),this.#d=t.writable,this.#o=t.writable.getWriter();break}default:throw this.free(),new Error(`Invalid protocol "${this.#e}"`)}this.#i=this.OPEN,this.dispatchEvent(new Event("open")),(async()=>{let t=!0;for(;t;){let{value:e,done:r}=await this.#a.read();t=!r,this.dispatchEvent(new MessageEvent("data",{data:e}))}})()}close(){switch(this.#i>this.OPEN&&console.debug(`${this.#e.toUpperCase()} connection is already closed.`),this.#i=this.CLOSING,this.#e){case"tcp":{this.#t?.close();break}default:throw this.free(),new Error(`Invalid protocol "${this.#e}"`)}this.#i=this.CLOSED,this.dispatchEvent(new Event("close"))}free(){return this.close(),this.#h=!0,this.#l.splice(0,this.#l.length)}constructor({proto:t,host:e,port:r},s){super(),t=t||"tcp",e=e||"127.0.0.1",r=r||80,this.#e=t,this.#r=e,this.#s=r,this.addEventListener("open",async()=>{this.#l.forEach(n=>{this.send(n)})}),this.addEventListener("close",()=>{this.#c.length&&this.#l.splice(0,0,this.#c.splice(0,this.#c.length))}),s&&this.connect()}},u,$=(u=class{},o(u,"RawClient",R),u),m=$;function b(){let t,e="pending",r=new Promise((s,n)=>{t={async resolve(i){await i,e="fulfilled",s(i)},reject(i){e="rejected",n(i)}}});return Object.defineProperty(r,"state",{get:()=>e}),Object.assign(r,t)}function N(t,e={}){let{signal:r,persistent:s}=e;return r?.aborted?Promise.reject(new DOMException("Delay was aborted.","AbortError")):new Promise((n,i)=>{let a=()=>{clearTimeout(w),i(new DOMException("Delay was aborted.","AbortError"))},w=setTimeout(()=>{r?.removeEventListener("abort",a),n()},t);if(r?.addEventListener("abort",a,{once:!0}),s===!1)try{Deno.unrefTimer(w)}catch(y){if(!(y instanceof ReferenceError))throw y;console.error("`persistent` option is only available in Deno")}})}var D=class{#e=0;#r=[];#s=[];#t=b();add(e){++this.#e,this.#n(e[Symbol.asyncIterator]())}async#n(e){try{let{value:r,done:s}=await e.next();s?--this.#e:this.#r.push({iterator:e,value:r})}catch(r){this.#s.push(r)}this.#t.resolve()}async*iterate(){for(;this.#e>0;){await this.#t;for(let e=0;e<this.#r.length;e++){let{iterator:r,value:s}=this.#r[e];yield s,this.#n(r)}if(this.#s.length){for(let e of this.#s)throw e;this.#s.length=0}this.#r.length=0,this.#t=b()}}[Symbol.asyncIterator](){return this.iterate()}},f="Server closed",k=5,P=1e3,p=class{#e;#r;#s;#t=!1;#n=new Set;#d=new AbortController;#a=new Set;#o;constructor(e){this.#e=e.port,this.#r=e.hostname,this.#s=e.handler,this.#o=e.onError??function(r){return console.error(r),new Response("Internal Server Error",{status:500})}}async serve(e){if(this.#t)throw new Deno.errors.Http(f);this.#f(e);try{return await this.#i(e)}finally{this.#u(e);try{e.close()}catch{}}}async listenAndServe(){if(this.#t)throw new Deno.errors.Http(f);let e=Deno.listen({port:this.#e??80,hostname:this.#r??"0.0.0.0",transport:"tcp"});return await this.serve(e)}async listenAndServeTls(e,r){if(this.#t)throw new Deno.errors.Http(f);let s=Deno.listenTls({port:this.#e??443,hostname:this.#r??"0.0.0.0",certFile:e,keyFile:r,transport:"tcp"});return await this.serve(s)}close(){if(this.#t)throw new Deno.errors.Http(f);this.#t=!0;for(let e of this.#n)try{e.close()}catch{}this.#n.clear(),this.#d.abort();for(let e of this.#a)this.#h(e);this.#a.clear()}get closed(){return this.#t}get addrs(){return Array.from(this.#n).map(e=>e.addr)}async#l(e,r){let s;try{if(s=await this.#s(e.request,r),s.bodyUsed&&s.body!==null)throw new TypeError("Response body already consumed.")}catch(n){s=await this.#o(n)}try{await e.respondWith(s)}catch{}}async#c(e,r){for(;!this.#t;){let s;try{s=await e.nextRequest()}catch{break}if(s===null)break;this.#l(s,r)}this.#h(e)}async#i(e){let r;for(;!this.#t;){let s;try{s=await e.accept()}catch(a){if(a instanceof Deno.errors.BadResource||a instanceof Deno.errors.InvalidData||a instanceof Deno.errors.UnexpectedEof||a instanceof Deno.errors.ConnectionReset||a instanceof Deno.errors.NotConnected){r?r*=2:r=k,r>=1e3&&(r=P);try{await N(r,{signal:this.#d.signal})}catch(h){if(!(h instanceof DOMException&&h.name==="AbortError"))throw h}continue}throw a}r=void 0;let n;try{n=Deno.serveHttp(s)}catch{continue}this.#p(n);let i={localAddr:s.localAddr,remoteAddr:s.remoteAddr};this.#c(n,i)}}#h(e){this.#w(e);try{e.close()}catch{}}#f(e){this.#n.add(e)}#u(e){this.#n.delete(e)}#p(e){this.#a.add(e)}#w(e){this.#a.delete(e)}};function I(t){return t==="0.0.0.0"?"localhost":t}async function C(t,e={}){let r=e.port??8e3,s=e.hostname??"0.0.0.0",n=new p({port:r,hostname:s,handler:t,onError:e.onError});e?.signal?.addEventListener("abort",()=>n.close(),{once:!0});let i=Deno.listen({port:r,hostname:s,transport:"tcp"}),a=n.serve(i);return r=n.addrs[0].port,"onListen"in e?e.onListen?.({port:r,hostname:s}):console.log(`Listening on http://${I(s)}:${r}/`),await a}var L='<!DOCTYPE html><head><meta charset="utf-8"/><title>WingBlade error</title><style>body{background:#000;color:#ccc;}</style></head><body><div style="width:75vw;min-width:360px;max-width:1080px;margin:0 auto;"><p>WingBlade has encountered an error on ${runtime}.</p><pre>${stackTrace}</pre></div></body>\n';var B=class{static serve(t,e={}){let r=`file://${Deno.cwd()}`;return e?.onListen||(e.onListen=function({port:s,hostname:n}){n=="0.0.0.0"&&(n="127.0.0.1"),console.error(`WingBlade serving at http://${n}:${s}`)}),e?.hostname||(e.hostname="0.0.0.0"),e?.port||(e.port=8e3),C(async(s,n)=>{try{let i=await t(s,n);return i?.constructor==Response?i:new Response(JSON.stringify(i),{headers:{"Content-Type":"text/plain"}})}catch(i){return console.error(`Request error at ${s.method} ${s.url}
${i.stack}`),new Response(L.replace("${runtime}",WingBlade.rt.variant).replace("${stackTrace}",i.stack.replaceAll(r,"wingblade:app")),{status:502,headers:{"Content-Type":"text/html"}})}},e)}static acceptWs(t,e){return Deno.upgradeWebSocket(t,e)}},x=B;var H=class{static randomInt(t){return Math.floor(Math.random()*t)}static sleep(t,e=0){return new Promise(r=>{AbortSignal.timeout(t+Math.floor(e*Math.random())).addEventListener("abort",()=>{r()})})}},S=H;var c,ce=(c=class{},o(c,"args",Deno.args),o(c,"rt",v),o(c,"env",g),o(c,"file",E),o(c,"net",m),o(c,"web",x),o(c,"util",S),c);export{ce as WingBlade};
